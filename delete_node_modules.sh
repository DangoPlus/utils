#!/bin/bash

# 确保脚本在遇到任何错误时终止执行
set -e

# 用法说明
if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <path_to_directory>"
  exit 1
fi

# 要搜索的起始目录
START_DIR=$1

# 避免在根目录运行脚本
if [ "$START_DIR" == "/" ]; then
  echo "Dangerous operation not allowed: Cannot run this script on root directory."
  exit 1
fi

# 查找所有名为 'node_modules' 的文件夹
echo "Searching for node_modules folders under: $START_DIR"
IFS=$'\n' # 修改字段分隔符，以便正确处理包含空格的路径
NODE_MODULES_DIRS=($(find "$START_DIR" -name 'node_modules' -type d -prune))

TOTAL=${#NODE_MODULES_DIRS[@]}

if [ $TOTAL -eq 0 ]; then
  echo "No node_modules folders found."
  exit 0
fi

echo "The following node_modules directories will be deleted:"
for DIR in "${NODE_MODULES_DIRS[@]}"; do
  echo "${DIR}"
done

# 确认删除
read -p "Are you sure you want to delete all the above directories? (y/n) " -n 1 -r
echo    # 新行
if [[ ! $REPLY =~ ^[Yy]$ ]]
then
  echo "Deletion cancelled."
  exit 1
fi

# 执行删除操作
for DIR in "${NODE_MODULES_DIRS[@]}"; do
  if [ -L "$DIR" ]; then # 检查是否为符号链接
    echo "Skipping symbolic link: ${DIR}"
  else
    echo "Deleting ${DIR}"
    rm -rf "${DIR}"
  fi
done

echo "Deletion complete."